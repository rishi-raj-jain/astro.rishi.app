---
import Layout from '@/layouts/Layout.astro'
import SearchBar from '@/components/SearchBar'
import DateString from '@/components/DateString.astro'
import RichTextResolver from 'storyblok-js-client/dist/rich-text-resolver.cjs'
import { getAllPostsForHome, getRecommendedPosts, getTagline } from '@/src/lib/api'

let data = undefined

try {
  const allPosts = (await getAllPostsForHome()) || new Array(5).fill(0).map((i, _) => _)
  const recommendedPosts = (await getRecommendedPosts()) || new Array(5).fill(0).map((i, _) => _)
  const blogsTagline = await getTagline('blogs')
  data = { allPosts, recommendedPosts, blogsTagline }
} catch (e) {
  console.log(e)
}
---

<Layout valid={data} content={{ title: 'Blogs - Rishi Raj Jain' }}>
  <div class="flex flex-col">
    <h1 class="text-2xl font-bold sm:text-5xl">Blogs</h1>
    <h2
      set:html={data.blogsTagline ? new RichTextResolver().render(data.blogsTagline) : 'placeholder tagline'}
      class={`font-regular text-md mt-5 whitespace-pre-line dark:text-gray-400 sm:text-xl ${
        data.blogsTagline ? '' : 'bg-black dark:bg-gray-400 animate-pulse'
      }`}
    />
    {
      data.allPosts[0] != 0 && (
        <span class="hide-if-no-javascript w-full">
          <SearchBar client:only="react" />
        </span>
      )
    }
    <div class="flex flex-row flex-wrap">
      <div class="mt-10 flex w-full flex-col items-center lg:mt-20 lg:w-2/3 lg:pr-10">
        <div class="relative space-y-8 columns-1 sm:columns-2">
          {
            data.allPosts.map((item, _) => (
              <a
                href={item && item.slug ? `/blog/${item.slug}` : ''}
                class="flex break-inside-avoid flex-col rounded border border-t-0 dark:border-gray-700"
              >
                {item?.content?.image && (
                  <img
                    src={item.content.image}
                    loading={_ === 0 ? 'eager' : 'lazy'}
                    class="mb-5 h-auto w-full rounded border shadow grayscale hover:grayscale-0"
                  />
                )}
                <span
                  id={`first_published_at_${_}`}
                  class={`px-4 text-gray-700 dark:text-gray-400 ${
                    item && item.first_published_at ? '' : 'w-[250px] animate-pulse bg-gray-700 dark:bg-gray-400'
                  } ${item?.content?.image ? '' : 'mt-5'}`}
                >
                  {item && item.first_published_at ? <DateString date={new Date(item.first_published_at)} /> : 'placeholder date'}
                </span>
                <span class={`text-md mt-3 px-4 font-bold hover:underline ${item && item.slug ? '' : 'animate-pulse bg-black'}`}>
                  {item && item.content ? item.content.title : 'placeholder title'}
                </span>
                <span
                  class={`line-clamp-2 mt-3 px-4 text-xs text-gray-700 dark:text-gray-400 ${
                    item && item.content ? '' : 'w-[200px] animate-pulse bg-gray-700 dark:bg-gray-400'
                  }`}
                >
                  {item && item.content ? item.content.intro : 'placeholder intro'}
                </span>
                <span
                  class={`mb-5 mt-5 px-4 text-sm uppercase text-blue-500 hover:underline ${
                    item && item.slug ? '' : 'w-[100px] animate-pulse bg-blue-500'
                  }`}
                >
                  Read More &rarr;
                </span>
              </a>
            ))
          }
        </div>
      </div>
      <div class="mt-0 flex w-full flex-col lg:mt-20 lg:w-1/3">
        <h4 class="text-md font-bold sm:text-lg">Recommended Posts</h4>
        {
          data.recommendedPosts.map((item) => (
            <a
              rel="noopener"
              target="_blank"
              href={item && item.content ? item.content.Url.url : ''}
              class={`mt-5 truncate border-b pb-2 text-sm text-gray-500 hover:underline dark:border-gray-700 dark:text-gray-400 ${
                item && item.content ? '' : 'animate-pulse bg-gray-500 dark:bg-gray-400'
              }`}
            >
              {item && item.content ? item.content.Title : 'placeholder title'}
            </a>
          ))
        }
      </div>
    </div>
  </div>
</Layout>

<script is:inline defer>
  setTimeout(() => {
    if (document.querySelector('#first_published_at_0').classList.contains('animate-pulse')) {
      window.location = '/404'
    }
  }, 2000)
</script>
